<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ±‚èŒè¿½è¸ª Â· 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161920;
    --border: #252830;
    --accent: #e8c86e;
    --accent2: #5b9cf6;
    --accent3: #6ee8a8;
    --text: #e8eaf0;
    --muted: #7a7f90;
    --danger: #f06e6e;
    --warning: #f0a86e;
    --sidebar-w: 340px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    display: flex;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at 20% 20%, rgba(91,156,246,0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, rgba(232,200,110,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .main {
    flex: 1;
    padding: 40px 28px;
    overflow-y: auto;
    position: relative;
    z-index: 1;
    transition: margin-right 0.3s ease;
  }

  .main.sidebar-open { margin-right: var(--sidebar-w); }
  .container { max-width: 1000px; margin: 0 auto; }

  header {
    margin-bottom: 36px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
  }

  .header-left h1 {
    font-family: 'Noto Serif SC', serif;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--accent);
  }

  .header-left p { color: var(--muted); font-size: 0.72rem; margin-top: 6px; letter-spacing: 0.1em; }
  .stats { display: flex; gap: 14px; flex-wrap: wrap; }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 18px;
    text-align: center;
    min-width: 76px;
  }

  .stat-num { font-size: 1.4rem; font-weight: 700; color: var(--accent); display: block; }
  .stat-label { font-size: 0.63rem; color: var(--muted); margin-top: 2px; letter-spacing: 0.08em; }

  .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }

  input[type="text"], select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    padding: 9px 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="text"]:focus, select:focus { border-color: var(--accent); }
  input[type="text"] { width: 190px; }
  select option { background: var(--surface); }

  .btn {
    padding: 9px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    transition: all 0.2s;
  }

  .btn-primary { background: var(--accent); color: #0d0f14; }
  .btn-primary:hover { background: #f0d88a; transform: translateY(-1px); }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent2); color: var(--accent2); }
  .btn-ai { background: rgba(91,156,246,0.15); color: var(--accent2); border: 1px solid rgba(91,156,246,0.3); }
  .btn-ai:hover { background: rgba(91,156,246,0.25); }
  .btn-ai.active { background: rgba(91,156,246,0.3); border-color: var(--accent2); }

  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  thead tr { background: rgba(232,200,110,0.06); border-bottom: 1px solid var(--border); }

  th {
    padding: 13px 14px;
    text-align: left;
    font-size: 0.63rem;
    letter-spacing: 0.15em;
    color: var(--accent);
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
  }

  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; animation: rowIn 0.3s ease forwards; opacity: 0; }

  @keyframes rowIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  tbody tr:hover { background: rgba(255,255,255,0.025); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 12px 14px; font-size: 0.78rem; vertical-align: middle; }

  td input, td select {
    width: 100%;
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.76rem;
    padding: 3px 7px;
    transition: border-color 0.2s;
  }

  td input:hover, td select:hover, td input:focus, td select:focus {
    border-color: var(--border);
    background: rgba(255,255,255,0.04);
    outline: none;
  }

  td select option { background: #161920; }

  .badge { display: inline-block; padding: 2px 9px; border-radius: 20px; font-size: 0.65rem; font-weight: 700; letter-spacing: 0.04em; white-space: nowrap; }
  .badge-pending   { background: rgba(122,127,144,0.2); color: var(--muted); }
  .badge-viewed    { background: rgba(91,156,246,0.2);  color: var(--accent2); }
  .badge-test      { background: rgba(240,168,110,0.2); color: var(--warning); }
  .badge-interview { background: rgba(232,200,110,0.2); color: var(--accent); }
  .badge-offer     { background: rgba(110,232,168,0.2); color: var(--accent3); }
  .badge-reject    { background: rgba(240,110,110,0.15); color: var(--danger); }

  .delete-btn { background: none; border: none; color: var(--border); cursor: pointer; font-size: 0.9rem; padding: 3px 7px; border-radius: 4px; transition: color 0.2s; }
  .delete-btn:hover { color: var(--danger); }

  .empty { text-align: center; padding: 56px 20px; color: var(--muted); font-size: 0.78rem; letter-spacing: 0.1em; }
  .empty span { display: block; font-size: 2rem; margin-bottom: 10px; opacity: 0.4; }

  .add-form { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; margin-top: 14px; display: none; animation: fadeIn 0.2s ease; }
  .add-form.open { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .add-form h3 { font-size: 0.72rem; letter-spacing: 0.12em; color: var(--accent); margin-bottom: 14px; text-transform: uppercase; }

  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; margin-bottom: 14px; }

  .form-group label { display: block; font-size: 0.62rem; color: var(--muted); letter-spacing: 0.1em; margin-bottom: 5px; text-transform: uppercase; }

  .form-group input, .form-group select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.78rem;
    padding: 8px 11px;
    outline: none;
  }

  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }
  .form-actions { display: flex; gap: 10px; }

  /* AI Sidebar */
  .ai-sidebar {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    width: var(--sidebar-w);
    background: #12151c;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .ai-sidebar.open { transform: translateX(0); }

  .ai-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .ai-header-left { display: flex; align-items: center; gap: 10px; }

  .ai-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); animation: pulse 2s infinite; }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .ai-title { font-size: 0.78rem; font-weight: 700; letter-spacing: 0.1em; color: var(--accent2); }
  .ai-sub { font-size: 0.6rem; color: var(--muted); margin-top: 2px; }

  .ai-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; padding: 4px; transition: color 0.2s; }
  .ai-close:hover { color: var(--text); }

  .ai-quick-btns { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 7px; }

  .quick-btn {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .quick-btn:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(91,156,246,0.08); }

  .ai-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 14px; }
  .ai-messages::-webkit-scrollbar { width: 4px; }
  .ai-messages::-webkit-scrollbar-track { background: transparent; }
  .ai-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg { display: flex; flex-direction: column; gap: 4px; }
  .msg-user { align-items: flex-end; }
  .msg-ai { align-items: flex-start; }

  .msg-bubble { max-width: 88%; padding: 10px 13px; border-radius: 12px; font-size: 0.75rem; line-height: 1.6; }

  .msg-user .msg-bubble { background: rgba(232,200,110,0.12); border: 1px solid rgba(232,200,110,0.2); color: var(--text); border-bottom-right-radius: 4px; }
  .msg-ai .msg-bubble { background: rgba(91,156,246,0.08); border: 1px solid rgba(91,156,246,0.15); color: var(--text); border-bottom-left-radius: 4px; }

  .msg-time { font-size: 0.58rem; color: var(--muted); padding: 0 4px; }

  .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 10px 13px; background: rgba(91,156,246,0.08); border: 1px solid rgba(91,156,246,0.15); border-radius: 12px; border-bottom-left-radius: 4px; width: fit-content; }

  .typing-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent2); opacity: 0.6; animation: typingBounce 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }

  .ai-input-area { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: flex-end; }

  .ai-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    padding: 10px 12px;
    resize: none;
    outline: none;
    min-height: 40px;
    max-height: 100px;
    transition: border-color 0.2s;
    line-height: 1.5;
  }

  .ai-input:focus { border-color: var(--accent2); }

  .send-btn { background: var(--accent2); border: none; border-radius: 8px; color: #0d0f14; cursor: pointer; font-size: 0.9rem; padding: 10px 14px; font-weight: 700; transition: all 0.2s; flex-shrink: 0; }
  .send-btn:hover { background: #7ab4f8; transform: translateY(-1px); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
</style>
</head>
<body>

<div class="main" id="main">
<div class="container">

  <header>
    <div class="header-left">
      <h1>æ±‚èŒè¿½è¸ª 2026</h1>
      <p>TRACK Â· ANALYZE Â· WIN</p>
    </div>
    <div class="stats">
      <div class="stat"><span class="stat-num" id="s-total">0</span><div class="stat-label">æ€»æŠ•é€’</div></div>
      <div class="stat"><span class="stat-num" id="s-active" style="color:var(--accent2)">0</span><div class="stat-label">è¿›è¡Œä¸­</div></div>
      <div class="stat"><span class="stat-num" id="s-interview" style="color:var(--accent)">0</span><div class="stat-label">é¢è¯•</div></div>
      <div class="stat"><span class="stat-num" id="s-offer" style="color:var(--accent3)">0</span><div class="stat-label">Offer</div></div>
    </div>
  </header>

  <div class="controls">
    <input type="text" id="search" placeholder="æœç´¢å…¬å¸ / å²—ä½...">
    <select id="filter-status" onchange="renderTable()">
      <option value="">å…¨éƒ¨çŠ¶æ€</option>
      <option value="å¾…å®¡æ ¸">å¾…å®¡æ ¸</option>
      <option value="å·²æŸ¥çœ‹">å·²æŸ¥çœ‹</option>
      <option value="ç¬”è¯•">ç¬”è¯•</option>
      <option value="é¢è¯•">é¢è¯•</option>
      <option value="Offer">Offer âœ“</option>
      <option value="å·²æŒ‚">å·²æŒ‚ âœ—</option>
    </select>
    <button class="btn btn-primary" onclick="toggleForm()">ï¼‹ æ·»åŠ è®°å½•</button>
    <button class="btn btn-ghost" onclick="exportCSV()">å¯¼å‡º CSV</button>
    <button class="btn btn-ghost" onclick="document.getElementById('csv-import-input').click()">å¯¼å…¥ CSV</button>
    <input type="file" id="csv-import-input" accept=".csv" style="display:none" onchange="importCSV(event)">
    <button class="btn btn-ai" id="ai-toggle-btn" onclick="toggleSidebar()">âœ¦ AI åˆ†æ</button>
  </div>

  <div class="add-form" id="add-form">
    <h3>æ–°å¢æŠ•é€’è®°å½•</h3>
    <div class="form-grid">
      <div class="form-group"><label>å…¬å¸åç§° *</label><input type="text" id="f-company" placeholder="å¦‚ï¼šå½±çŸ³ Insta360"></div>
      <div class="form-group"><label>å²—ä½åç§° *</label><input type="text" id="f-position" placeholder="å¦‚ï¼šèµ„é‡‘ç®¡åŸ¹ç”Ÿ"></div>
      <div class="form-group"><label>æŠ•é€’æ—¥æœŸ</label><input type="date" id="f-date"></div>
      <div class="form-group">
        <label>å½“å‰çŠ¶æ€</label>
        <select id="f-status">
          <option value="å¾…å®¡æ ¸">å¾…å®¡æ ¸</option>
          <option value="å·²æŸ¥çœ‹">å·²æŸ¥çœ‹</option>
          <option value="ç¬”è¯•">ç¬”è¯•</option>
          <option value="é¢è¯•">é¢è¯•</option>
          <option value="Offer">Offer âœ“</option>
          <option value="å·²æŒ‚">å·²æŒ‚ âœ—</option>
        </select>
      </div>
      <div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="f-note" placeholder="æˆªæ­¢æ—¥æœŸ / è¿›å±•..."></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="addEntry()">ç¡®è®¤æ·»åŠ </button>
      <button class="btn btn-ghost" onclick="toggleForm()">å–æ¶ˆ</button>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:14px">
    <table>
      <thead>
        <tr><th>#</th><th>å…¬å¸</th><th>å²—ä½</th><th>æŠ•é€’æ—¥æœŸ</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th><th></th></tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
    <div class="empty" id="empty-state"><span>ğŸ“‹</span>æš‚æ— è®°å½•ï¼Œç‚¹å‡»ã€Œæ·»åŠ è®°å½•ã€å¼€å§‹è¿½è¸ª</div>
  </div>

</div>
</div>

<!-- AI Sidebar -->
<div class="ai-sidebar" id="ai-sidebar">
  <div class="ai-header">
    <div class="ai-header-left">
      <div class="ai-dot"></div>
      <div>
        <div class="ai-title">AI æ±‚èŒåŠ©æ‰‹</div>
        <div class="ai-sub">åˆ†æä½ çš„æŠ•é€’æƒ…å†µ</div>
      </div>
    </div>
    <button class="ai-close" onclick="toggleSidebar()">âœ•</button>
  </div>

  <div class="ai-quick-btns">
    <button class="quick-btn" onclick="quickAsk('å¸®æˆ‘åˆ†æä¸€ä¸‹æˆ‘çš„æ•´ä½“æŠ•é€’æƒ…å†µ')">ğŸ“Š æ•´ä½“åˆ†æ</button>
    <button class="quick-btn" onclick="quickAsk('æˆ‘ç›®å‰æœ‰å“ªäº›æœºä¼šæœ€å€¼å¾—é‡ç‚¹è·Ÿè¿›ï¼Ÿ')">ğŸ¯ é‡ç‚¹æœºä¼š</button>
    <button class="quick-btn" onclick="quickAsk('æˆ‘çš„æŠ•é€’è¦†ç›–é¢å¤Ÿå—ï¼Ÿè¿˜åº”è¯¥æŠ•å“ªäº›å…¬å¸ï¼Ÿ')">ğŸ“ˆ æ‰©å¤§æŠ•é€’</button>
    <button class="quick-btn" onclick="quickAsk('æˆ‘ç›®å‰èƒœç‡å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ')">ğŸ’¡ èƒœç‡å»ºè®®</button>
  </div>

  <div class="ai-messages" id="ai-messages">
    <div class="msg msg-ai">
      <div class="msg-bubble">ä½ å¥½ Starï¼æˆ‘æ˜¯ä½ çš„æ±‚èŒåŠ©æ‰‹ âœ¦<br><br>æˆ‘å¯ä»¥å¸®ä½ åˆ†ææŠ•é€’æ•°æ®ã€æ‰¾å‡ºæœ€å€¼å¾—è·Ÿè¿›çš„æœºä¼šã€ç»™å‡ºæ‰©å¤§æŠ•é€’çš„å»ºè®®ã€‚<br><br>ç‚¹å‡»ä¸Šæ–¹å¿«æ·é—®é¢˜ï¼Œæˆ–ç›´æ¥è¾“å…¥ä½ çš„é—®é¢˜å§ï½</div>
      <div class="msg-time">åˆšåˆš</div>
    </div>
  </div>

  <div class="ai-input-area">
    <textarea class="ai-input" id="ai-input" placeholder="é—®æˆ‘å…³äºä½ çš„æ±‚èŒæƒ…å†µ..." rows="1" onkeydown="handleKey(event)"></textarea>
    <button class="send-btn" id="send-btn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
const STORAGE_KEY = 'job_tracker_2025';

const statusMap = { 'å¾…å®¡æ ¸':'pending','å·²æŸ¥çœ‹':'viewed','ç¬”è¯•':'test','é¢è¯•':'interview','Offer':'offer','å·²æŒ‚':'reject' };
const statusLabel = { 'å¾…å®¡æ ¸':'å¾…å®¡æ ¸','å·²æŸ¥çœ‹':'å·²æŸ¥çœ‹','ç¬”è¯•':'ç¬”è¯•','é¢è¯•':'é¢è¯•','Offer':'Offer âœ“','å·²æŒ‚':'å·²æŒ‚ âœ—' };

let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let aiHistory = [];
let sidebarOpen = false;

if (data.length === 0) {
  data = [
    { id:1, company:'å¹¿å·æœŸè´§äº¤æ˜“æ‰€', position:'é‡‘èè´¢ä¼šç±»', date:'2026-01', status:'å·²æŒ‚', note:'ç®€å†æœªè¿‡' },
    { id:2, company:'é¹ååŸºé‡‘', position:'æœºæ„ä¸šåŠ¡ç»ç†/åŠ©ç†ç ”ç©¶å‘˜', date:'2026-02', status:'å¾…å®¡æ ¸', note:'' },
    { id:3, company:'å½±çŸ³ Insta360', position:'èµ„é‡‘ç®¡åŸ¹ç”Ÿ/è¿è¥ç®¡åŸ¹ç”Ÿ', date:'2026-02', status:'å¾…å®¡æ ¸', note:'ç­›é€‰æœªå¼€å§‹' },
    { id:4, company:'vivo', position:'æˆ˜ç•¥è§„åˆ’ç»ç†', date:'2026-02', status:'ç¬”è¯•', note:'æµ‹è¯„è¿‡äº†ï¼Œ3.23-27é¢è¯•' },
    { id:5, company:'OPPO', position:'é£æ§ç­–ç•¥åˆ†æå¸ˆ/äº§å“ç»ç†', date:'2026-02', status:'å¾…å®¡æ ¸', note:'ç®€å†ç­›é€‰ä¸­' },
    { id:6, company:'åä¸º', position:'æ¶ˆè´¹è€…MTF/è½¦éƒ¨äº§å“ç»ç†', date:'2026-02', status:'å¾…å®¡æ ¸', note:'2.26åˆšä¿®æ”¹' },
    { id:7, company:'ä¸­å›½é‡‘å¸æœ‰é™å…¬å¸', position:'é¡¹ç›®å¼€å‘/ç®¡åŸ¹ç”Ÿ', date:'2026-01', status:'ç¬”è¯•', note:'ç¬”è¯•å®Œæ— æ¶ˆæ¯' },
    { id:8, company:'è´§æ‹‰æ‹‰', position:'å…¨çƒæ‹“å±•ç®¡åŸ¹ç”Ÿ', date:'2026-01', status:'å¾…å®¡æ ¸', note:'ä¼°è®¡æŒ‚äº†' },
    { id:9, company:'è¿…é›·', position:'X-PEPäº§å“æ˜Ÿè®¡åˆ’', date:'2026-02', status:'å¾…å®¡æ ¸', note:'åˆç­›' },
    { id:10, company:'æ‹›å•†é“¶è¡Œ', position:'å¸‚åœºè¥é”€/è¿œç¨‹å®¢æˆ·ç»ç†', date:'2026-02', status:'å¾…å®¡æ ¸', note:'ç®€å†ç­›é€‰' },
    { id:11, company:'äº¬ä¸œ', position:'é”€å”®è¿è¥/ç»¼åˆæ–¹å‘', date:'2026-02', status:'ç¬”è¯•', note:'ç¬”è¯•å®Œå†ç®€å†ç­›é€‰' },
    { id:12, company:'å­—èŠ‚è·³åŠ¨', position:'ç­–ç•¥äº§å“ç»ç†-çº¢æœçŸ­å‰§', date:'2026-02', status:'å¾…å®¡æ ¸', note:'æŠ•äº†æ²¡åç»­' },
    { id:13, company:'å¹¿å·æœŸè´§äº¤æ˜“æ‰€ç§‘æŠ€å­å…¬å¸', position:'é‡‘èå²—', date:'2026-02', status:'å¾…å®¡æ ¸', note:'bossç®€å†æœªé”' },
  ];
  save();
}

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

function renderTable() {
  const search = document.getElementById('search').value.toLowerCase();
  const filterStatus = document.getElementById('filter-status').value;
  const tbody = document.getElementById('table-body');
  const empty = document.getElementById('empty-state');

  let filtered = data.filter(d => {
    const matchSearch = !search || d.company.toLowerCase().includes(search) || d.position.toLowerCase().includes(search);
    const matchStatus = !filterStatus || d.status === filterStatus;
    return matchSearch && matchStatus;
  });

  tbody.innerHTML = '';
  empty.style.display = filtered.length === 0 ? 'block' : 'none';

  filtered.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.style.animationDelay = (i * 0.04) + 's';
    const cls = statusMap[row.status] || 'pending';
    tr.innerHTML = `
      <td style="color:var(--muted);font-size:0.68rem">${String(i+1).padStart(2,'0')}</td>
      <td><input type="text" value="${esc(row.company)}" onchange="updateField(${row.id},'company',this.value)"></td>
      <td><input type="text" value="${esc(row.position)}" onchange="updateField(${row.id},'position',this.value)"></td>
      <td><input type="text" value="${esc(row.date)}" onchange="updateField(${row.id},'date',this.value)" style="width:90px"></td>
      <td>
        <select onchange="updateField(${row.id},'status',this.value)">
          ${Object.keys(statusLabel).map(s=>`<option value="${s}" ${s===row.status?'selected':''}>${statusLabel[s]}</option>`).join('')}
        </select>
        <span class="badge badge-${cls}" style="margin-left:5px">${statusLabel[row.status]||row.status}</span>
      </td>
      <td><input type="text" value="${esc(row.note)}" onchange="updateField(${row.id},'note',this.value)" placeholder="å¤‡æ³¨..."></td>
      <td><button class="delete-btn" onclick="deleteRow(${row.id})">âœ•</button></td>
    `;
    tbody.appendChild(tr);
  });

  updateStats();
}

function updateStats() {
  document.getElementById('s-total').textContent = data.length;
  document.getElementById('s-active').textContent = data.filter(d=>!['å·²æŒ‚','Offer'].includes(d.status)).length;
  document.getElementById('s-interview').textContent = data.filter(d=>d.status==='é¢è¯•').length;
  document.getElementById('s-offer').textContent = data.filter(d=>d.status==='Offer').length;
}

function updateField(id, field, value) {
  const row = data.find(d=>d.id===id);
  if (row) { row[field]=value; save(); updateStats(); renderTable(); }
}

function deleteRow(id) { data=data.filter(d=>d.id!==id); save(); renderTable(); }

function toggleForm() {
  const f = document.getElementById('add-form');
  f.classList.toggle('open');
  if (f.classList.contains('open')) {
    document.getElementById('f-date').value = new Date().toISOString().slice(0,10);
    document.getElementById('f-company').focus();
  }
}

function addEntry() {
  const company = document.getElementById('f-company').value.trim();
  const position = document.getElementById('f-position').value.trim();
  if (!company || !position) { alert('å…¬å¸åç§°å’Œå²—ä½åç§°ä¸ºå¿…å¡«é¡¹'); return; }
  const newId = data.length ? Math.max(...data.map(d=>d.id))+1 : 1;
  data.push({ id:newId, company, position,
    date: document.getElementById('f-date').value || new Date().toISOString().slice(0,7),
    status: document.getElementById('f-status').value,
    note: document.getElementById('f-note').value.trim()
  });
  save(); renderTable(); toggleForm();
  ['f-company','f-position','f-note'].forEach(id=>document.getElementById(id).value='');
}

function exportCSV() {
  const headers = ['å…¬å¸','å²—ä½','æŠ•é€’æ—¥æœŸ','çŠ¶æ€','å¤‡æ³¨'];
  const rows = data.map(d=>[d.company,d.position,d.date,d.status,d.note].map(v=>`"${v}"`).join(','));
  const csv = [headers.join(','),...rows].join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download = 'æ±‚èŒè®°å½•_'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
}

function esc(s) { return (s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result.replace(/^\uFEFF/, ''); // strip BOM
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length < 2) { showToast('CSVæ–‡ä»¶å†…å®¹ä¸ºç©º', 'error'); return; }

      const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
      // flexible header mapping
      const colMap = {
        company: headers.findIndex(h => h.includes('å…¬å¸')),
        position: headers.findIndex(h => h.includes('å²—ä½')),
        date: headers.findIndex(h => h.includes('æ—¥æœŸ') || h.includes('date')),
        status: headers.findIndex(h => h.includes('çŠ¶æ€') || h.includes('status')),
        note: headers.findIndex(h => h.includes('å¤‡æ³¨') || h.includes('note')),
      };

      if (colMap.company === -1 || colMap.position === -1) {
        showToast('CSVæ ¼å¼ä¸å¯¹ï¼Œéœ€è¦åŒ…å«"å…¬å¸"å’Œ"å²—ä½"åˆ—', 'error'); return;
      }

      const validStatuses = ['å¾…å®¡æ ¸','å·²æŸ¥çœ‹','ç¬”è¯•','é¢è¯•','Offer','å·²æŒ‚'];
      let imported = 0;
      let skipped = 0;

      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        const company = (cols[colMap.company] || '').trim();
        const position = (cols[colMap.position] || '').trim();
        if (!company || !position) { skipped++; continue; }

        // check duplicate
        const isDup = data.some(d => d.company === company && d.position === position);
        if (isDup) { skipped++; continue; }

        const status = colMap.status !== -1 ? (cols[colMap.status] || '').trim() : '';
        const newId = data.length ? Math.max(...data.map(d=>d.id))+1 : 1;
        data.push({
          id: newId,
          company,
          position,
          date: colMap.date !== -1 ? (cols[colMap.date] || '').trim() : new Date().toISOString().slice(0,7),
          status: validStatuses.includes(status) ? status : 'å¾…å®¡æ ¸',
          note: colMap.note !== -1 ? (cols[colMap.note] || '').trim() : ''
        });
        imported++;
      }

      save(); renderTable();
      showToast(`æˆåŠŸå¯¼å…¥ ${imported} æ¡${skipped ? `ï¼Œè·³è¿‡ ${skipped} æ¡ï¼ˆé‡å¤æˆ–ç©ºè¡Œï¼‰` : ''}`, 'success');
    } catch(err) {
      showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
    }
    event.target.value = '';
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { current += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (ch === ',' && !inQuotes) {
      result.push(current); current = '';
    } else {
      current += ch;
    }
  }
  result.push(current);
  return result;
}

function showToast(msg, type) {
  const existing = document.getElementById('toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'toast';
  toast.textContent = msg;
  toast.style.cssText = `
    position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
    background:${type==='success' ? 'rgba(110,232,168,0.15)' : 'rgba(240,110,110,0.15)'};
    border:1px solid ${type==='success' ? 'rgba(110,232,168,0.4)' : 'rgba(240,110,110,0.4)'};
    color:${type==='success' ? '#6ee8a8' : '#f06e6e'};
    padding:12px 24px; border-radius:8px; font-size:0.78rem;
    font-family:'Space Mono',monospace; z-index:9999;
    animation:fadeIn 0.2s ease;
  `;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity 0.3s'; setTimeout(()=>toast.remove(), 300); }, 3000);
}

// AI Sidebar
function toggleSidebar() {
  sidebarOpen = !sidebarOpen;
  document.getElementById('ai-sidebar').classList.toggle('open', sidebarOpen);
  document.getElementById('main').classList.toggle('sidebar-open', sidebarOpen);
  document.getElementById('ai-toggle-btn').classList.toggle('active', sidebarOpen);
}

function getDataSummary() {
  const total = data.length;
  const byStatus = {};
  data.forEach(d=>{ byStatus[d.status]=(byStatus[d.status]||0)+1; });
  const list = data.map(d=>`${d.company}ï¼ˆ${d.position}ï¼‰- ${d.status}${d.note?'ï¼Œå¤‡æ³¨ï¼š'+d.note:''}`).join('\n');
  return `æ±‚èŒè®°å½•å…±${total}æ¡ï¼š\n${list}\n\nçŠ¶æ€æ±‡æ€»ï¼š${JSON.stringify(byStatus)}`;
}

function quickAsk(text) {
  document.getElementById('ai-input').value = text;
  sendMessage();
}

function handleKey(e) {
  if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

async function sendMessage() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.style.height = 'auto';
  appendMsg('user', text);
  aiHistory.push({ role:'user', content:text });

  const sendBtn = document.getElementById('send-btn');
  sendBtn.disabled = true;
  const typingEl = showTyping();

  try {
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ±‚èŒé¡¾é—®AIåŠ©æ‰‹ã€‚ä½ æ­£åœ¨å¸®åŠ©ä¸€ä½å«Starçš„æ­¦æ±‰å¤§å­¦é‡‘èç¡•å£«ç ”ç©¶ç”Ÿåˆ†ææ±‚èŒæƒ…å†µã€‚

ä»–çš„èƒŒæ™¯ï¼šæ­¦æ±‰å¤§å­¦é‡‘èç¡•å£«ï¼ˆGPA3.52ï¼‰ï¼Œæœ¬ç§‘å¹¿ä¸œè´¢ç»å¤§å­¦ç”µå­å•†åŠ¡ï¼Œæ ¸å¿ƒé¡¹ç›®æœ‰Hestonæ¨¡å‹ç¢³æœŸæƒå®šä»·ï¼ˆPythonï¼‰å’Œé‡åŒ–é€‰è‚¡ç­–ç•¥ï¼ˆRè¯­è¨€ï¼Œå¹´åŒ–è¶…é¢11.16%ï¼‰ï¼Œæœ‰å·¥å•†é“¶è¡Œå®¢æˆ·ç»ç†å®ä¹ ã€‚ä»–å–œæ¬¢æ¥è§¦æ–°äº‹ç‰©ï¼Œå¯ä»¥æ¥å—å¸‚åœºä¸Šçš„ä¼—å¤šè¡Œä¸šï¼Œå–œæ¬¢æŒ‘æˆ˜è‡ªå·±æ¥å—å¸‚åœºä¸Šæ–°çš„ä¸œè¥¿ã€‚

${getDataSummary()}

è¯·æ ¹æ®å®é™…æŠ•é€’æ•°æ®ç»™å‡ºå…·ä½“å»ºè®®ã€‚è¯­æ°”å°–é”å®¢è§‚ï¼Œç”¨ä¸­æ–‡ï¼Œä¸è¦å¤ªé•¿ã€‚`;

    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: aiHistory.slice(-8)
      })
    });

    const result = await response.json();
    const reply = result.content?.[0]?.text || 'æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•å›åº”ï¼Œè¯·ç¨åå†è¯•ã€‚';
    typingEl.remove();
    appendMsg('ai', reply);
    aiHistory.push({ role:'assistant', content:reply });

  } catch(err) {
    typingEl.remove();
    appendMsg('ai', 'ç½‘ç»œå‡ºç°äº†ç‚¹é—®é¢˜ï¼Œè¯·ç¨åå†è¯• ğŸ™');
  }

  sendBtn.disabled = false;
}

function appendMsg(role, text) {
  const messages = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  const now = new Date();
  const time = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  div.innerHTML = `<div class="msg-bubble">${text.replace(/\n/g,'<br>')}</div><div class="msg-time">${time}</div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const messages = document.getElementById('ai-messages');
  const div = document.createElement('div');
  div.className = 'msg msg-ai';
  div.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

document.getElementById('ai-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100)+'px';
});

document.getElementById('search').addEventListener('input', renderTable);
renderTable();
</script>
</body>
</html>
